#!/usr/bin/env bash
#
# Red Specter – ADV Exploitation Helper v1.0
# File: adv/adv-exploitation/redspecter-exploit-adv.sh
#
# Exploitation PLANNING helper:
# - Does NOT run exploits
# - Helps you structure exploitation notes
# - Suggests commands (nmap/searchsploit/msfconsole) for manual use
#
# ROE: Only for use on lab systems or targets with explicit written permission
#      for exploitation attempts.
#

set -euo pipefail

VERSION="1.0"

# ---------- Colours ----------
RED="$(tput setaf 1 2>/dev/null || true)"
GREEN="$(tput setaf 2 2>/dev/null || true)"
YELLOW="$(tput setaf 3 2>/dev/null || true)"
BLUE="$(tput setaf 4 2>/dev/null || true)"
BOLD="$(tput bold 2>/dev/null || true)"
RESET="$(tput sgr0 2>/dev/null || true)"

# ---------- Paths ----------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
REPORT_DIR="${BASE_DIR}/reports"

# ---------- Helpers ----------
usage() {
  cat <<EOF

===========================================
   RED SPECTER - ADV EXPLOIT HELPER v${VERSION}
===========================================

Exploitation PLANNING helper (no automatic exploit execution).

Usage:
  $(basename "$0") -t <tag> -H <host> -p <port> -s <service> [-n <nmap_file>]

Options:
  -t, --tag TAG         Run label (e.g. CLIENT-APP-01, LAB-BOX-1)
  -H, --host HOST       Target host/IP
  -p, --port PORT       Target port
  -s, --service TEXT    Service banner / product info (e.g. 'OpenSSH 8.2p1')
  -n, --nmap FILE       Optional reference to Nmap output file
  -h, --help            Show this help

If no options are provided, interactive mode will prompt for details.

EOF
}

authorization_prompt() {
  echo
  echo "${YELLOW}${BOLD}ROE / AUTHORIZATION CHECK (ADV EXPLOIT HELPER)${RESET}"
  echo "${YELLOW}This helper is for planning exploitation attempts on:${RESET}"
  echo "${YELLOW}  • Lab systems you fully control, OR${RESET}"
  echo "${YELLOW}  • Client systems with explicit written permission for exploitation.${RESET}"
  echo
  read -r -p "Do you confirm you are authorised to plan exploitation for this target? (yes/no): " ans
  case "$ans" in
    yes|y|Y)
      echo "${GREEN}[+] Authorization confirmed.${RESET}"
      ;;
    *)
      echo "${RED}[!] Authorization not confirmed. Aborting.${RESET}"
      exit 1
      ;;
  esac
}

planning_ack_prompt() {
  echo
  echo "${BLUE}[i] Reminder: This helper will NOT run exploits.${RESET}"
  echo "${BLUE}[i] It only suggests commands and structures notes for manual use.${RESET}"
  echo
  local phrase="THIS IS A PLANNING TOOL ONLY"
  echo "To continue, type the following phrase exactly:"
  echo "  ${BOLD}${phrase}${RESET}"
  echo
  read -r -p "> " typed
  if [[ "$typed" != "$phrase" ]]; then
    echo
    echo "${RED}[!] Phrase mismatch. Aborting.${RESET}"
    exit 1
  fi
  echo
  echo "${GREEN}[+] Acknowledged. Continuing with exploitation planning.${RESET}"
  echo
}

banner() {
  echo
  echo "${RED}${BOLD}===========================================${RESET}"
  echo "${RED}${BOLD}   RED SPECTER - ADV EXPLOIT HELPER v${VERSION}${RESET}"
  echo "${RED}${BOLD}===========================================${RESET}"
  echo
  echo "${YELLOW}Exploitation planning helper (no automatic exploitation).${RESET}"
  echo "${YELLOW}Use only under proper ROE or in your lab.${RESET}"
  echo
}

# ---------- Main ----------
main() {
  local TAG=""
  local HOST=""
  local PORT=""
  local SERVICE=""
  local NMAP_FILE=""

  # Interactive mode if no args
  if [[ $# -eq 0 ]]; then
    banner
    echo "${BLUE}[i] No arguments supplied — entering interactive mode.${RESET}"
    echo
    read -rp "Enter run tag/label (e.g. CLIENT-APP-01, LAB-BOX-1): " TAG
    read -rp "Enter target host/IP: " HOST
    read -rp "Enter target port: " PORT
    read -rp "Enter service/banner info (e.g. 'OpenSSH 8.2p1 Ubuntu'): " SERVICE
    read -rp "Optional: path to related Nmap output file (or press Enter to skip): " NMAP_FILE
  else
    # Parse arguments
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -t|--tag)
          TAG="${2:-}"
          shift 2
          ;;
        -H|--host)
          HOST="${2:-}"
          shift 2
          ;;
        -p|--port)
          PORT="${2:-}"
          shift 2
          ;;
        -s|--service)
          SERVICE="${2:-}"
          shift 2
          ;;
        -n|--nmap)
          NMAP_FILE="${2:-}"
          shift 2
          ;;
        -h|--help)
          usage
          exit 0
          ;;
        *)
          echo "${RED}[!] Unknown argument: $1${RESET}"
          usage
          exit 1
          ;;
      esac
    done
  fi

  # Basic validation
  if [[ -z "$TAG" || -z "$HOST" || -z "$PORT" || -z "$SERVICE" ]]; then
    echo "${RED}[!] Tag, host, port, and service are all required fields.${RESET}"
    usage
    exit 1
  fi

    banner
  authorization_prompt
  planning_ack_prompt
  

  # Prepare report directory
  mkdir -p "${REPORT_DIR}"
  local ts
  ts="$(date +'%Y%m%d_%H%M%S')"

  local safe_tag
  safe_tag="$(echo "$TAG" | sed 's/[^A-Za-z0-9._-]/_/g')"
  local safe_host
  safe_host="$(echo "$HOST" | sed 's/[^A-Za-z0-9._-]/_/g')"

  local RUN_DIR="${REPORT_DIR}/adv-exploit_${safe_tag}_${safe_host}_${ts}"
  mkdir -p "${RUN_DIR}"/summary

  echo
  echo "${GREEN}[+] Run directory: ${RUN_DIR}${RESET}"
  echo

  local SUMMARY_MD="${RUN_DIR}/Exploit_Plan_${safe_host}_${PORT}.md"

  # Build suggested commands (purely for planning)
  local nmap_detail_cmd="nmap -Pn -sV -sC -p ${PORT} ${HOST} -oN detailed_${safe_host}_${PORT}.txt"
  local searchsploit_cmd="searchsploit \"${SERVICE}\""
  local msf_search_cmd="msfconsole -q -x \"search ${SERVICE}; exit\""

  # Ask for any known CVEs / notes
  echo "${BLUE}[i] Optional: add any known CVE IDs or public advisories (comma-separated).${RESET}"
  read -rp "Known CVEs (or press Enter if none): " KNOWN_CVES
  echo "${BLUE}[i] Optional: short description of suspected weakness (e.g. 'outdated SSH, weak cipher').${RESET}"
  read -rp "Suspected weakness: " SUSPECTED_WEAKNESS

  # Generate Markdown plan
  {
    echo "# Red Specter – Exploitation Planning Note"
    echo
    echo "- **Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')"
    echo "- **Tag/Engagement:** \`${TAG}\`"
    echo "- **Host:** \`${HOST}\`"
    echo "- **Port:** \`${PORT}\`"
    echo "- **Service/Banner:** \`${SERVICE}\`"
    if [[ -n "$NMAP_FILE" ]]; then
      echo "- **Related Nmap File:** \`${NMAP_FILE}\`"
    fi
    echo "- **Module:** ADV Exploitation Helper v${VERSION}"
    echo
    echo "## ROE / Scope Reminder"
    echo
    echo "> This note is for planning exploitation attempts ONLY."
    echo "> Actual exploit execution must be within explicit written ROE or lab scope."
    echo
    echo "## Suspected Weakness"
    echo
    if [[ -n "$SUSPECTED_WEAKNESS" ]]; then
      echo "- ${SUSPECTED_WEAKNESS}"
    else
      echo "- (Not specified yet)"
    fi
    echo
    echo "## Known CVEs or Advisories"
    echo
    if [[ -n "$KNOWN_CVES" ]]; then
      echo "- ${KNOWN_CVES}"
    else
      echo "- None documented yet."
    fi
    echo
    echo "## Recommended Enumeration Steps"
    echo
    echo "1. **Service verification**"
    echo "   - Confirm the service and version are accurate using a focused scan:"
    echo "     \`\`\`bash"
    echo "     ${nmap_detail_cmd}"
    echo "     \`\`\`"
    echo
    echo "2. **Research potential exploits**"
    echo "   - Search local exploit references with searchsploit:"
    echo "     \`\`\`bash"
    echo "     ${searchsploit_cmd}"
    echo "     \`\`\`"
    echo "   - Search within Metasploit framework:"
    echo "     \`\`\`bash"
    echo "     ${msf_search_cmd}"
    echo "     \`\`\`"
    echo
    echo "3. **Vendor / official advisories**"
    echo "   - Check vendor changelogs and security advisories."
    echo "   - Cross-check version against known vulnerable releases."
    echo
    echo "## Exploitation Plan (To Be Completed Manually)"
    echo
    echo "- **Primary exploit path:**"
    echo "  - (e.g. CVE-XXXX-YYYY, Metasploit module name, or manual exploit script)"
    echo "- **Preconditions / requirements:**"
    echo "  - (e.g. credentials, network position, user interaction)"
    echo "- **Potential impact:**"
    echo "  - (e.g. RCE, privilege escalation, data exposure)"
    echo
    echo "## Evidence & Notes"
    echo
    echo "- Capture all commands, outputs, and PoC details here."
    echo "- Ensure sensitive data is handled per client agreement."
    echo
    echo "## Reporting Reminders"
    echo
    echo "- Clearly separate *verified* exploitation from **suspected** vulnerabilities."
    echo "- Include:"
    echo "  - Steps to reproduce (non-destructive where possible)"
    echo "  - Impact description in business terms"
    echo "  - Recommended mitigation / patching guidance"
    echo
    echo "> This note was generated by Red Specter ADV Exploitation Helper v${VERSION}."
  } > "$SUMMARY_MD"

  echo
  echo "${GREEN}[+] Exploitation planning note created.${RESET}"
  echo "${GREEN}[+] File: ${SUMMARY_MD}${RESET}"
  echo
  echo "${YELLOW}Reminder:${RESET} This tool does NOT run exploits. Use the suggested commands manually and lawfully."
  echo
}

main "$@"
